<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ejemplo AJAX</title>
</head>

<script type="application/javascript">

/*
Podríamos decir que AJAX es un conjunto de APIs utilizadas por el navegador web y lenguajes 
de scripting, como JavaScript, para transferir XML y otros datos en formato de texto, desde 
y hacia un servidor web, mediante el protocolo de comunicaciones HTTP. 

Ventajas:
    1) Reducimos el ancho de banda requerido, al no tener que recuperar toda la página.
    2) Agilizamos la actualización y eliminamos el parpadeo de la página.
Inconvenientes:
    1) No es posible volver a la página anterior. Además, si guardamos la página en favoritos 
    puede ser almacenada una diferente a aquella en la que estamos.
    2) Puede causar problemas con navegadores antiguos que no implementan esta tecnología.
    3) No funciona si el usuario tiene desactivado Javascript en su navegador.

Pasos de ejecución en AJAX (Dibujo 6_LlamadaAjax.png)
    1) Se produce un evento en la web, como la carga de la página, un clic en un botón...
        1.1 ) JavaScript crea un objeto XMLHttpRequest.
    2) El nuevo objeto XMLHttpRequest envía una solicitud a un servidor web.
    3) El servidor procesa la solicitud aplicando la logica de negocio oportuna
    4) El servidor normalmente accede a una BBDD para acceder a la información
    5) El servidor envía la respuesta a la web en un formato (normalmente JSON o XML)
    6) JavaScript lee la respuesta y realiza la acción adecuada a esa respuesta (normalmente mostrar
    la informacion al usuario).

Propiedades mas imporantes del objeto XMLHttpRequest:
    this.responseText //El body en bruto
    this.responseXML  //Si el body contenía un XML, el XML procesado
    this.status       //Código de respuesta
    this.statusText   //Texto asociado al código de respuesta  
    this.readyState   //Estado del objeto
    
    - Propiedades pensadas para que coloquemos funciones de retrollamada
    o "callback"

    this.onreadystatechange = null 
    this.onload  = null
    this.onerror = null

Metodos mas importantes del objeto XMLHttpRequest
    XMLHttpRequest.open() //Decimos la URL donde queremos ir a buscar la información
    XMLHttpRequest.send() //Enviamos la información al servidor

*/

//En caso de TOMCAT habria que cambiar al puerto 8080, en apache al 80
const URL_DESTINO = "http://localhost:5500/09_AJAX/"
const RECURSO = "fichero.txt"

function enviarPeticionSincrona(){

    let xmlHttp = new XMLHttpRequest()

    //xmlHttp.open(método (str), url (str), asíncrono/síncrono (true/false) )
    xmlHttp.open('GET', URL_DESTINO + RECURSO, false)
    xmlHttp.send(null) //Lo que queremos que vaya en el body se pasa como
                       //parámetro a la función send
    
    xmlHttp.responseText //El body en bruto
    xmlHttp.responseXML  //Si el body contenía un XML, el XML procesado
    xmlHttp.status       //Código de respuesta
    xmlHttp.statusText   //Texto asociado al código de respuesta

    console.log("================================")
    console.log("Response text:"+xmlHttp.responseText)
    console.log("Status       :"+xmlHttp.status)
    console.log("Status text  :"+xmlHttp.statusText)
    
    procesarRespuesta(xmlHttp.responseText)
}

function enviarPeticionAsincrona(){

    let xmlHttp = new XMLHttpRequest()
    
    //Metodos de retrollamada/callbacks
    xmlHttp.onreadystatechange = function(){
        //propiedad readyState
        //0-Valor inicial, simplemente hemos creado el objeto xmlHttpRequest
        //1-Open
        //2-Send
        //3-Comienza a recibirse la respuesta
        //4-Respuesta completa
        if( this.readyState == 4){
            if(this.status == 200){
                procesarRespuesta(this.responseText)
            } else {
                alert("ZASCA!")
            }
        }
    }

    xmlHttp.open('GET',URL_DESTINO + RECURSO, true)
    xmlHttp.send(null)
    console.log("responseText:"+xmlHttp.responseText)

}

function peticionAjax(){

    let xmlHttp = new XMLHttpRequest()
    let parametros = "nombre="+nombre.value
    xmlHttp.open('GET', URL_DESTINO + RECURSO, true)
    xmlHttp.send() 

    xmlHttp.onload = function(){
        procesarRespuesta(this.responseText)
    }

    xmlHttp.onerror = function(){
        alert("ZAS!")
    }

}

function procesarRespuesta(respuesta){
    resultadoBusqueda.innerHTML = "<h2>"+respuesta+"</h2>"
}

</script>

<body>
    <h1>EJEMPLO AJAX</h1>

    <button id="btnBuscarSincrono"  onclick="enviarPeticionSincrona()">Buscar síncrono</button>
    <button id="btnBuscarAsincrono" onclick="enviarPeticionAsincrona()">Buscar asíncrono</button>
    <button id="btnBuscarAsincrono" onclick="peticionAjax()">Petición AJAX</button>

    <div id="resultadoBusqueda"></div>
</body>
</html>